#!/bin/bash
set -ex

if [ $# -ne 3 ]
then
  echo "$0 <type> <toolchain> <sanitizer>" >&2
  exit 2
fi

TYPE=$1
TOOLCHAIN=$2
SANITIZER=$3
shift 3

APP_DIR=$(dirname "$(readlink -e "$0")")
SRC_DIR=$(readlink -e "$APP_DIR/..")

cd "$SRC_DIR/build/"
mkdir -p "${TOOLCHAIN}/$TYPE/${SANITIZER}"
cd "$_"

if [ "$TOOLCHAIN" = "default" ]
then
  TCC=""
else
  TCC="-DCMAKE_TOOLCHAIN_FILE=../../../../src/cmake/toolchains/${TOOLCHAIN}.cmake"
fi

if [ "$SANITIZER" = "none" ]
then
  SAN=""
else
  SAN="-DSANITIZE=$SANITIZER"
fi

time cmake $TCC $SAN "-DCMAKE_BUILD_TYPE=$TYPE" -G Ninja "$SRC_DIR"
time ninja all
time ctest || ctest -V
